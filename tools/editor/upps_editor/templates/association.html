<h2 class="text-xl font-semibold text-white mb-6">関連性ネットワーク</h2>

<!-- Association List -->
<div class="space-y-4 mb-8">
    <template x-for="(association, index) in profile.association_system?.associations || []" :key="index">
        <div class="bento-card rounded-xl p-4">
            <div class="grid grid-cols-3 gap-4">
                <!-- Trigger Section -->
                <div>
                    <h3 class="text-white font-medium mb-2">トリガー</h3>
                    <div class="space-y-2 association-trigger p-3">
                        <!-- Trigger Type Selection -->
                        <select x-model="association.trigger.type" @change="updateAssociationOptions(index)" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_type`">
                            <option value="memory">記憶</option>
                            <option value="emotion">感情</option>
                            <option value="external">外部トリガー</option>
                            <option value="complex">複合条件</option>
                        </select>
                        
                        <!-- Complex Trigger -->
                        <template x-if="association.trigger.type === 'complex'">
                            <div>
                                <select x-model="association.trigger.operator" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_operator`">
                                    <option value="AND">AND（すべて満たす）</option>
                                    <option value="OR">OR（いずれかを満たす）</option>
                                </select>
                                <button @click="addComplexCondition(index)" class="mt-2 glass hover:glass-bright rounded px-3 py-1 text-white text-sm">
                                    <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>条件を追加
                                </button>
                                
                                <template x-for="(condition, conditionIndex) in association.trigger.conditions || []" :key="conditionIndex">
                                    <div class="mt-2 p-2 bg-white/5 rounded complex-condition">
                                        <select x-model="condition.type" @change="updateComplexConditionType(index, conditionIndex)" class="w-full glass rounded px-2 py-1 text-white text-xs mb-1">
                                            <option value="memory">記憶</option>
                                            <option value="emotion">感情</option>
                                            <option value="external">外部</option>
                                        </select>
                                        
                                        <template x-if="condition.type === 'memory'">
                                            <select x-model="condition.id" class="w-full glass rounded px-2 py-1 text-white text-xs">
                                                <template x-for="memory in profile.memory_system?.memories || []" :key="memory.id">
                                                    <option :value="memory.id" x-text="memory.id"></option>
                                                </template>
                                            </select>
                                        </template>
                                        
                                        <template x-if="condition.type === 'emotion'">
                                            <div>
                                                <select x-model="condition.id" class="w-full glass rounded px-2 py-1 text-white text-xs mb-1">
                                                    <template x-for="emotion in Object.keys(profile.emotion_system?.emotions || {})" :key="emotion">
                                                        <option :value="emotion" x-text="getEmotionLabel(emotion)"></option>
                                                    </template>
                                                </select>
                                                <input type="number" x-model.number="condition.threshold" placeholder="閾値" min="0" max="100" class="w-full glass rounded px-2 py-1 text-white text-xs">
                                            </div>
                                        </template>
                                        
                                        <template x-if="condition.type === 'external'">
                                            <div>
                                                <select x-model="condition.category" class="w-full glass rounded px-2 py-1 text-white text-xs mb-1">
                                                    <option value="topics">トピック</option>
                                                    <option value="environment">環境</option>
                                                    <option value="keywords">キーワード</option>
                                                </select>
                                                <input type="text" :value="getExternalConditionItems(index, conditionIndex)" @input="updateExternalConditionItems(index, conditionIndex, $event)" class="w-full glass rounded px-2 py-1 text-white text-xs" placeholder="カンマ区切り">
                                            </div>
                                        </template>
                                        
                                        <button @click="removeComplexCondition(index, conditionIndex)" class="mt-1 text-red-400 hover:text-red-300 text-xs">
                                            削除
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                        <!-- Memory Trigger -->
                        <template x-if="association.trigger.type === 'memory'">
                            <select x-model="association.trigger.id" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_id`">
                                <option value="">記憶を選択</option>
                                <template x-for="memory in profile.memory_system?.memories || []" :key="memory.id">
                                    <option :value="memory.id" x-text="memory.id + ' (' + memory.type + ')'"></option>
                                </template>
                            </select>
                        </template>
                        
                        <!-- Emotion Trigger -->
                        <template x-if="association.trigger.type === 'emotion'">
                            <div>
                                <select x-model="association.trigger.id" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_id`">
                                    <option value="">感情を選択</option>
                                    <template x-for="emotion in Object.keys(profile.emotion_system?.emotions || {})" :key="emotion">
                                        <option :value="emotion" x-text="getEmotionLabel(emotion)"></option>
                                    </template>
                                </select>
                                <input type="number" x-model.number="association.trigger.threshold" placeholder="閾値 (例：70)" min="0" max="100" class="mt-2 w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_threshold`">
                            </div>
                        </template>
                        
                        <!-- External Trigger -->
                        <template x-if="association.trigger.type === 'external'">
                            <div>
                                <select x-model="association.trigger.category" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_category`">
                                    <option value="topics">トピック</option>
                                    <option value="environment">環境</option>
                                    <option value="keywords">キーワード</option>
                                </select>
                                <input type="text" x-model="externalItems[index]" @input="updateExternalItems(index)" placeholder="例：花, 草木, 自然" class="mt-2 w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_trigger_items`">
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Response Section -->
                <div>
                    <h3 class="text-white font-medium mb-2">応答</h3>
                    <div class="space-y-2 association-response p-3">
                        <select x-model="association.response.type" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_response_type`">
                            <option value="memory">記憶</option>
                            <option value="emotion">感情</option>
                        </select>
                        
                        <!-- Memory Response -->
                        <template x-if="association.response.type === 'memory'">
                            <select x-model="association.response.id" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_response_id`">
                                <option value="">記憶を選択</option>
                                <template x-for="memory in profile.memory_system?.memories || []" :key="memory.id">
                                    <option :value="memory.id" x-text="memory.id + ' (' + memory.type + ')'"></option>
                                </template>
                            </select>
                        </template>
                        
                        <!-- Emotion Response -->
                        <template x-if="association.response.type === 'emotion'">
                            <select x-model="association.response.id" class="w-full glass rounded px-3 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400" :data-validation="`assoc_${index}_response_id`">
                                <option value="">感情を選択</option>
                                <template x-for="emotion in Object.keys(profile.emotion_system?.emotions || {})" :key="emotion">
                                    <option :value="emotion" x-text="getEmotionLabel(emotion)"></option>
                                </template>
                            </select>
                        </template>
                        
                        <div class="flex items-center">
                            <span class="text-white/60 text-sm mr-2">関連強度:</span>
                            <input type="range" x-model.number="association.response.association_strength" min="0" max="100" class="slider flex-1" :style="'--value: ' + association.response.association_strength" :data-validation="`assoc_${index}_response_strength`">
                            <span class="text-white text-sm ml-2" x-text="association.response.association_strength + '%'"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="text-right pt-4">
                    <button @click="removeAssociation(index)" class="text-red-400 hover:text-red-300 transition">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <button @click="addAssociation()" class="w-full glass hover:glass-bright rounded-lg px-4 py-3 text-white flex items-center justify-center space-x-2 transition">
        <i data-lucide="plus" class="w-4 h-4"></i>
        <span>関連性を追加</span>
    </button>
</div>

<!-- Visual Editor (Future) -->
<div class="bento-card rounded-xl p-6 text-center">
    <i data-lucide="network" class="w-8 h-8 text-cyan-400 mx-auto mb-2"></i>
    <h3 class="text-lg text-white mb-1">ビジュアルエディタ</h3>
    <p class="text-white/50 text-sm mb-4">近日実装予定</p>
    <button class="glass px-4 py-2 rounded text-white/50 cursor-not-allowed" disabled>開く</button>
</div>